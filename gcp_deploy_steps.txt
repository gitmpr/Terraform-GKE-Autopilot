GCP deployment steps for spring-petclinic
multi-project setup with terraform and artifact registry in main project

projects:
tf-gcp-proj-main  - Shared infrastructure (Terraform state, Artifact Registry, Secrets)
tf-gcp-proj-test  - Test environment (Cloud Run, Cloud SQL)
tf-gcp-proj-prod       - Production environment (Cloud Run, Cloud SQL)


# Prerequisites

Required tools:
- gcloud CLI (authenticated with your GCP account)
- gh CLI (authenticated with GitHub - run: gh auth login)
- Docker
- Terraform >= 1.5

# Find your billing account ID
gcloud billing accounts list


# Set active Google account
gcloud config configurations activate tf-gcp-proj-prod

# Create GCP projects
gcloud projects create tf-gcp-proj-main \
  --name="GorillaClinic Main"

gcloud projects create tf-gcp-proj-test \
  --name="GorillaClinic Test"

# gcloud projects create tf-gcp-proj-prod \
#   --name="GorillaClinic Prod"
# (tf-gcp-proj-prod project was already provided for this setup)



# Link projects to billing account
# Replace BILLING_ACCOUNT_ID with your billing account ID from the list above

gcloud billing projects link tf-gcp-proj-main \
  --billing-account=BILLING_ACCOUNT_ID

gcloud billing projects link tf-gcp-proj-test \
  --billing-account=BILLING_ACCOUNT_ID

gcloud billing projects link tf-gcp-proj-prod \
  --billing-account=BILLING_ACCOUNT_ID


# Enable APIs in main project (shared infrastructure)

gcloud services enable \
  storage.googleapis.com \
  artifactregistry.googleapis.com \
  secretmanager.googleapis.com \
  iam.googleapis.com \
  cloudresourcemanager.googleapis.com \
  sqladmin.googleapis.com \
  --project=tf-gcp-proj-main

gcloud services list --enabled --project=tf-gcp-proj-main


# Enable APIs in test project

gcloud services enable \
  run.googleapis.com \
  sqladmin.googleapis.com \
  secretmanager.googleapis.com \
  compute.googleapis.com \
  servicenetworking.googleapis.com \
  --project=tf-gcp-proj-test

gcloud services list --enabled --project=tf-gcp-proj-test


# Enable APIs in prod project

gcloud services enable \
  run.googleapis.com \
  sqladmin.googleapis.com \
  secretmanager.googleapis.com \
  compute.googleapis.com \
  servicenetworking.googleapis.com \
  --project=tf-gcp-proj-prod

gcloud services list --enabled --project=tf-gcp-proj-prod


# Create Terraform state bucket in main project

gsutil mb -p tf-gcp-proj-main -l europe-west1 gs://tf-gcp-proj-main-tfstate

gsutil versioning set on gs://tf-gcp-proj-main-tfstate

gsutil ls -L -b gs://tf-gcp-proj-main-tfstate


# Artifact Registry and cross-project IAM are managed by Terraform
# See terraform/shared-infrastructure.tf and terraform/artifact-registry-iam.tf
# Terraform will create the registry and configure permissions automatically

# Configure local Docker to push to Artifact Registry
gcloud auth configure-docker europe-west1-docker.pkg.dev


# Create Terraform Service Account in main project

gcloud iam service-accounts create terraform-sa \
  --display-name="Terraform Service Account" \
  --project=tf-gcp-proj-main


# Grant Terraform Service Account permissions on all projects
# For PoC: Using Owner role for simplicity
# For Production: Use least-privilege roles (see note below)

gcloud projects add-iam-policy-binding tf-gcp-proj-main \
  --member="serviceAccount:terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com" \
  --role="roles/owner"

gcloud projects add-iam-policy-binding tf-gcp-proj-test \
  --member="serviceAccount:terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com" \
  --role="roles/owner"

gcloud projects add-iam-policy-binding tf-gcp-proj-prod \
  --member="serviceAccount:terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com" \
  --role="roles/owner"

# Production Note: Least-privilege roles for Terraform SA
# Instead of Owner, grant these specific roles:
# - roles/editor (base permissions)
# - roles/artifactregistry.admin (manage Artifact Registry IAM)
# - roles/run.admin (manage Cloud Run IAM)
# - roles/cloudsql.admin (manage Cloud SQL)
# - roles/compute.admin (manage GKE/networking)
# - roles/iam.serviceAccountAdmin (manage service accounts)


# Generate Terraform Service Account key

gcloud iam service-accounts keys create ./terraform-gcp-sa-key.json \
  --iam-account=terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com


# Store Terraform Service Account key in GCP Secret Manager

gcloud secrets create terraform-gcp-sa-key \
  --replication-policy="automatic" \
  --project=tf-gcp-proj-main \
  --labels="purpose=terraform,environment=all"

gcloud secrets versions add terraform-gcp-sa-key \
  --data-file=terraform-gcp-sa-key.json \
  --project=tf-gcp-proj-main


# Store Terraform Service Account key in GitHub Secret

gh auth switch --user gitmpr
gh secret set TERRAFORM_GCP_SA_KEY < ./terraform-gcp-sa-key.json


# Cloud Run Service Accounts are now managed by Terraform
# See terraform/service-accounts.tf for the service account configuration
# Terraform will automatically create:
#   - Cloud Run workload service account (cloudrun-petclinic-sa)
#   - IAM bindings for cloudsql.client role
#   - IAM bindings for secretmanager.secretAccessor role
# These are created automatically when you run terraform apply in test/prod workspaces


# Create GitHub environments

gh api repos/:owner/:repo/environments/test --method PUT
gh api repos/:owner/:repo/environments/prod --method PUT


# Set GitHub environment variables for test environment

gh variable set GCP_PROJECT_ID --body="tf-gcp-proj-test" --env=test
gh variable set GCP_REGION --body="europe-west1" --env=test
gh variable set ENVIRONMENT_NAME --body="test" --env=test
gh variable set CLOUD_RUN_SERVICE_NAME --body="petclinic-test" --env=test
gh variable set CLOUD_SQL_INSTANCE_NAME --body="petclinic-db-test" --env=test
gh variable set TERRAFORM_STATE_PREFIX --body="test" --env=test


# Set GitHub environment variables for prod environment

gh variable set GCP_PROJECT_ID --body="tf-gcp-proj-prod" --env=prod
gh variable set GCP_REGION --body="europe-west1" --env=prod
gh variable set ENVIRONMENT_NAME --body="prod" --env=prod
gh variable set CLOUD_RUN_SERVICE_NAME --body="petclinic-prod" --env=prod
gh variable set CLOUD_SQL_INSTANCE_NAME --body="petclinic-db-prod" --env=prod
gh variable set TERRAFORM_STATE_PREFIX --body="prod" --env=prod


# Verify GitHub setup

gh secret list
gh variable list --env=test
gh variable list --env=prod


# Initialize and test Terraform deployment

cd terraform
terraform init

# Create Terraform workspaces for test and prod environments
terraform workspace new test
terraform workspace new prod
terraform workspace select test
terraform workspace list

# Plan and apply for test environment
terraform plan -var-file=vars/test/env.tfvars
terraform apply -var-file=vars/test/env.tfvars


# Build and push Docker image
# (This will be automated in GitHub Actions later)

# Optional: Test locally first with resource constraints matching Cloud Run
# docker build -t petclinic-test .
# docker run --rm -p 8080:8080 --cpus="1" --memory="512m" petclinic-test

# Build and push to Artifact Registry (created by Terraform above)
cd ..
docker build -t europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images/petclinic:latest .
docker push europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images/petclinic:latest


# Note on service account key file
# For PoC convenience, we keep terraform-gcp-sa-key.json in the repo root
# For production, this should be retrieved from Secret Manager and deleted after use


# Infrastructure summary

# Main Project (tf-gcp-proj-main):
#   Terraform state bucket: gs://tf-gcp-proj-main-tfstate
#   Artifact Registry: europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images (Terraform-managed)
#   Secret Manager: terraform-gcp-sa-key
#   Terraform Service Account: terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com (Owner role)

# Test Project (tf-gcp-proj-test):
#   Cloud Run service: petclinic-test (deployed)
#   Service URL: https://petclinic-test-lfikytfcma-ew.a.run.app
#   Resources: 1 CPU, 512Mi RAM, 0-10 instances
#   Database: Cloud SQL PostgreSQL (ZONAL)
#   Cloud SQL instance: petclinic-db-test (deployed)
#   Cloud SQL connection: tf-gcp-proj-test:europe-west1:petclinic-db-test
#   Service Account: cloudrun-petclinic-sa@tf-gcp-proj-test.iam.gserviceaccount.com (Terraform-managed)

# Prod Project (tf-gcp-proj-prod):
#   Cloud Run service: petclinic-prod (deployed)
#   Service URL: https://petclinic-prod-zdihkaopnq-ew.a.run.app
#   Resources: 2 CPU, 1Gi RAM, 1-100 instances
#   Database: Cloud SQL PostgreSQL (REGIONAL - high availability)
#   Cloud SQL instance: petclinic-db-prod (deployed)
#   Cloud SQL connection: tf-gcp-proj-prod:europe-west1:petclinic-db-prod
#   Service Account: cloudrun-petclinic-sa@tf-gcp-proj-prod.iam.gserviceaccount.com (Terraform-managed)


# Docker image tags
# Primary tag: europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images/petclinic:<git-sha>
# Add additional tags via: gcloud artifacts docker tags add SOURCE-IMAGE TARGET-IMAGE


# Terraform workspaces
# test workspace deploys to tf-gcp-proj-test project
# prod workspace deploys to tf-gcp-proj-prod project


# Note on container build strategy
# Consider with Java developers: For production it could be better to use the
# cloud native buildpacks for automated security patches in the Java application
# container image, but for now we will stick with the Dockerfile for simplicity
# in the PoC.
