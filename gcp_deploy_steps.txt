GCP deployment steps for spring-petclinic
multi-project setup with terraform stacks and GKE Autopilot

projects:
tf-gcp-proj-main  - Shared infrastructure (Terraform state, Artifact Registry, Secrets)
tf-gcp-proj-test  - Test environment (GKE Autopilot, Cloud SQL)
tf-gcp-proj-prod       - Production environment (GKE Autopilot, Cloud SQL)


# Prerequisites

Required tools:
- gcloud CLI (authenticated with your GCP account)
- gh CLI (authenticated with GitHub - run: gh auth login)
- kubectl (for Kubernetes cluster management)
- Docker
- Terraform >= 1.5

# Find your billing account ID
gcloud billing accounts list


# Set active Google account
gcloud config configurations activate tf-gcp-proj-prod

# Create GCP projects
gcloud projects create tf-gcp-proj-main \
  --name="GorillaClinic Main"

gcloud projects create tf-gcp-proj-test \
  --name="GorillaClinic Test"

# gcloud projects create tf-gcp-proj-prod \
#   --name="GorillaClinic Prod"
# (tf-gcp-proj-prod project was already provided for this setup)



# Link projects to billing account
# Replace BILLING_ACCOUNT_ID with your billing account ID from the list above

gcloud billing projects link tf-gcp-proj-main \
  --billing-account=BILLING_ACCOUNT_ID

gcloud billing projects link tf-gcp-proj-test \
  --billing-account=BILLING_ACCOUNT_ID

gcloud billing projects link tf-gcp-proj-prod \
  --billing-account=BILLING_ACCOUNT_ID


# Enable APIs in main project (shared infrastructure)

gcloud services enable \
  storage.googleapis.com \
  artifactregistry.googleapis.com \
  secretmanager.googleapis.com \
  iam.googleapis.com \
  cloudresourcemanager.googleapis.com \
  --project=tf-gcp-proj-main

gcloud services list --enabled --project=tf-gcp-proj-main


# Enable APIs in test project

gcloud services enable \
  container.googleapis.com \
  sqladmin.googleapis.com \
  secretmanager.googleapis.com \
  compute.googleapis.com \
  servicenetworking.googleapis.com \
  --project=tf-gcp-proj-test

gcloud services list --enabled --project=tf-gcp-proj-test


# Enable APIs in prod project

gcloud services enable \
  container.googleapis.com \
  sqladmin.googleapis.com \
  secretmanager.googleapis.com \
  compute.googleapis.com \
  servicenetworking.googleapis.com \
  --project=tf-gcp-proj-prod

gcloud services list --enabled --project=tf-gcp-proj-prod


# Create Terraform state bucket in main project

gsutil mb -p tf-gcp-proj-main -l europe-west1 gs://tf-gcp-proj-main-tfstate

gsutil versioning set on gs://tf-gcp-proj-main-tfstate

gsutil ls -L -b gs://tf-gcp-proj-main-tfstate


# Configure local Docker to push to Artifact Registry
gcloud auth configure-docker europe-west1-docker.pkg.dev


# Create Terraform Service Account in main project

gcloud iam service-accounts create terraform-sa \
  --display-name="Terraform Service Account" \
  --project=tf-gcp-proj-main


# Grant Terraform Service Account permissions on all projects
# For PoC: Using Owner role for simplicity
# For Production: Use least-privilege roles (see note below)

gcloud projects add-iam-policy-binding tf-gcp-proj-main \
  --member="serviceAccount:terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com" \
  --role="roles/owner"

gcloud projects add-iam-policy-binding tf-gcp-proj-test \
  --member="serviceAccount:terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com" \
  --role="roles/owner"

gcloud projects add-iam-policy-binding tf-gcp-proj-prod \
  --member="serviceAccount:terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com" \
  --role="roles/owner"

# Production Note: Least-privilege roles for Terraform SA
# Instead of Owner, grant these specific roles:
# - roles/editor (base permissions)
# - roles/artifactregistry.admin (manage Artifact Registry)
# - roles/container.admin (manage GKE)
# - roles/cloudsql.admin (manage Cloud SQL)
# - roles/compute.admin (manage VPC networking)
# - roles/iam.serviceAccountAdmin (manage service accounts)


# Generate Terraform Service Account key

gcloud iam service-accounts keys create ./terraform-gcp-sa-key.json \
  --iam-account=terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com


# Store Terraform Service Account key in GCP Secret Manager

gcloud secrets create terraform-gcp-sa-key \
  --replication-policy="automatic" \
  --project=tf-gcp-proj-main \
  --labels="purpose=terraform,environment=all"

gcloud secrets versions add terraform-gcp-sa-key \
  --data-file=terraform-gcp-sa-key.json \
  --project=tf-gcp-proj-main


# Store Terraform Service Account key in GitHub Secret

gh auth switch --user gitmpr
gh secret set TERRAFORM_GCP_SA_KEY < ./terraform-gcp-sa-key.json


# Deploy shared infrastructure stack
# This creates the Artifact Registry for container images

cd terraform/stacks/shared

terraform init
terraform plan
terraform apply

cd ../../..


# Deploy test environment stack
# This creates: VPC, GKE Autopilot cluster, Cloud SQL PostgreSQL, Service Accounts

gcloud config configurations activate tf-gcp-proj-test

cd terraform/stacks/env

terraform init
terraform workspace new test
terraform workspace select test
terraform plan -var-file=env.d/test.tfvars
terraform apply -var-file=env.d/test.tfvars

cd ../../..


# Deploy prod environment stack
# This creates: VPC, GKE Autopilot cluster, Cloud SQL PostgreSQL, Service Accounts

gcloud config configurations activate tf-gcp-proj-prod

cd terraform/stacks/env

terraform workspace new prod
terraform workspace select prod
terraform plan -var-file=env.d/prod.tfvars
terraform apply -var-file=env.d/prod.tfvars

cd ../../..


# Configure kubectl to access GKE clusters

# For test cluster
gcloud config configurations activate tf-gcp-proj-test
gcloud container clusters get-credentials gorillaclinic-k8s-gke-test \
  --region=europe-west1 \
  --project=tf-gcp-proj-test

# For prod cluster
gcloud config configurations activate tf-gcp-proj-prod
gcloud container clusters get-credentials gorillaclinic-k8s-gke-prod \
  --region=europe-west1 \
  --project=tf-gcp-proj-prod


# Build and push Docker image
# (This will be automated in GitHub Actions later)

# Optional: Test locally first with resource constraints
# docker build -t petclinic-test .
# docker run --rm -p 8080:8080 --cpus="1" --memory="512m" petclinic-test

# Build and push to Artifact Registry (created by Terraform shared stack)
docker build -t europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images/petclinic:latest .
docker push europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images/petclinic:latest


# Note on service account key file
# For PoC convenience, we keep terraform-gcp-sa-key.json in the repo root
# For production, use Workload Identity Federation for GitHub Actions
# TODO: Remove service account key references from terraform code


# Infrastructure summary

# Main Project (tf-gcp-proj-main):
#   Terraform state bucket: gs://tf-gcp-proj-main-tfstate
#   State files:
#     - shared/default.tfstate (shared infrastructure)
#     - env/env:test/default.tfstate (test environment workspace)
#     - env/env:prod/default.tfstate (prod environment workspace)
#   Artifact Registry: europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images
#   Secret Manager: terraform-gcp-sa-key
#   Terraform Service Account: terraform-sa@tf-gcp-proj-main.iam.gserviceaccount.com (Owner role)

# Test Project (tf-gcp-proj-test):
#   GKE Autopilot cluster: gorillaclinic-k8s-gke-test
#   Region: europe-west1
#   VPC: petclinic-vpc-test
#   Database: Cloud SQL PostgreSQL (ZONAL, db-f1-micro)
#   Cloud SQL instance: petclinic-db-test (private IP only)
#   Cloud SQL database: petclinic
#   Service Account: petclinic-app-test@tf-gcp-proj-test.iam.gserviceaccount.com
#   Permissions: cloudsql.client, secretmanager.secretAccessor

# Prod Project (tf-gcp-proj-prod):
#   GKE Autopilot cluster: gorillaclinic-k8s-gke-prod
#   Region: europe-west1
#   VPC: petclinic-vpc-prod
#   Database: Cloud SQL PostgreSQL (REGIONAL, db-custom-2-7680)
#   Cloud SQL instance: petclinic-db-prod (private IP only)
#   Cloud SQL database: petclinic
#   Service Account: petclinic-app-prod@tf-gcp-proj-prod.iam.gserviceaccount.com
#   Permissions: cloudsql.client, secretmanager.secretAccessor


# Terraform stack architecture

# terraform/stacks/shared/
#   Purpose: Shared infrastructure across all environments
#   Resources: Artifact Registry
#   State: gs://tf-gcp-proj-main-tfstate/shared/
#   Project: tf-gcp-proj-main

# terraform/stacks/env/
#   Purpose: Environment-specific GKE and Cloud SQL infrastructure
#   Resources: VPC, GKE Autopilot, Cloud SQL, Service Accounts
#   State: gs://tf-gcp-proj-main-tfstate/env/env:{workspace}/
#   Workspaces: test, prod
#   Projects: tf-gcp-proj-test (test workspace), tf-gcp-proj-prod (prod workspace)
#   Config files: env.d/test.tfvars, env.d/prod.tfvars


# Docker image tags
# Primary tag: europe-west1-docker.pkg.dev/tf-gcp-proj-main/petclinic-images/petclinic:<git-sha>
# Add additional tags via: gcloud artifacts docker tags add SOURCE-IMAGE TARGET-IMAGE


# Next steps
# - Create Kubernetes manifests for deploying petclinic application to GKE
# - Set up Workload Identity binding between Kubernetes service account and GCP service account
# - Configure Cloud SQL Proxy or Private Service Connect for database access from pods
# - Create GitHub Actions workflows for automated deployments
